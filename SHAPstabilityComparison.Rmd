---
title: "MultiSHAP Comparison"
output: html_document
date: "2025-12-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##### Multi SHAP comparison:

```{r}
library(caret)
library(fastshap)
library(shapviz)
library(dplyr)

set.seed(123)

tuneGrid <- expand.grid(
  n.trees = c(50, 100),
  interaction.depth = c(1, 2),
  shrinkage = c(0.05, 0.1),
  n.minobsinnode = 10
)

df <- opt.Datos.Train.FinnishRecurTraditionalROCtidymodelsTraditional 

df <- na.roughfix(df)

df <- df %>%
  mutate(across(where(is.numeric), ~ if (all(na.omit(.) %in% c(0, 1))) factor(.) else .
  ))

df$recurrence_risk <- as.factor(df$recurrence_risk)
n_classes <- length(levels(df$recurrence_risk ))
n_classes
classes <- levels(df$recurrence_risk )

X <- df[, setdiff(names(df), "recurrence_risk")]
y <- df$recurrence_risk 

K <- 10
R <- 10
n_background <- 50 

folds <- createMultiFolds(y, k = K, times = R)  

index_folds <- lapply(folds, function(train_idx) {
  list(
    analysis = train_idx,
    assessment = setdiff(seq_len(nrow(df)), train_idx)
  )
})

safe_pred <- function(object, newdata, class_k) {
  probs <- predict(object, newdata, type = "prob")
  if (!(class_k %in% colnames(probs))) {
    return(rep(0, nrow(newdata)))
  }
  out <- probs[, class_k]
  out[is.na(out)] <- 0
  out
}

results_folds <- list()

for (i in seq_along(index_folds)) {
  
  cat("\n----------------------------------------\n")
  cat("Fold", i, "of", length(index_folds), "\n")
  
  idx_train <- index_folds[[i]]$analysis
  X_train <- X[idx_train, ]
  y_train <- y[idx_train]
  
  tuneGrid <- expand.grid(
    n.trees = 50,
    interaction.depth = 2,
    shrinkage = 0.05,
    n.minobsinnode = 10
  )
  
  model_fold <- train(
    x = X_train,
    y = y_train,
    method = "gbm",
    metric = "AUC",
    tuneGrid = tuneGrid,
    trControl = trainControl(
      method = "none",
      classProbs = TRUE,
      summaryFunction = multiClassSummary
    ),
    verbose = FALSE
  )
  
  shap_per_class <- list()
  summary_per_class <- list()
  
  for (k in seq_along(classes)) {
    
    class_k <- classes[k]
    cat("   Calculating SHAP for class:", class_k, "\n")
    
    f_pred <- function(object, newdata) {
      probs <- predict(object, newdata, type = "prob")
      if (!(class_k %in% colnames(probs))) {
        return(rep(0, nrow(newdata)))
      }
      out <- probs[, class_k]
      out[is.na(out)] <- 0
      return(as.numeric(out))
    }
  
    shap_vals <- try(fastshap::explain(
      object = model_fold,
      X = X_train,
      pred_wrapper = f_pred,
      nsim = 50 
    ), silent = TRUE)
    
    if (inherits(shap_vals, "try-error")) {
      warning(paste("fastshap failed in fold", i, "class", class_k))
      next
    }
    
    shap_per_class[[class_k]] <- shap_vals
    
    sspearman_k <- map_dfr(colnames(X_train), function(v) {

  idx_class <- which(y_train == class_k)

  x <- X_train[idx_class, v]
  s <- as.numeric(shap_vals[idx_class, v])

  if (length(unique(x)) < 2 || sd(s) == 0) {
    return(data.frame(
      variable = v,
      rho_spearman = NA,
      p_value = NA,
      mean_abs_shap = NA
    ))
  }

  test <- suppressWarnings(
    cor.test(x, s, method = "spearman", exact = FALSE)   #Spearman calculation intra-fold
  )

  data.frame(
    variable = v,
    rho_spearman = unname(test$estimate),
    p_value = test$p.value,
    mean_abs_shap = mean(abs(s))
  )
})

    summary_k <- sspearman_k %>%
  mutate(class = class_k) %>%
  arrange(desc(mean_abs_shap))
    
    summary_per_class[[class_k]] <- summary_k
  }
  
  results_folds[[i]] <- list(
    model = model_fold,
    shap = shap_per_class,
    summary = summary_per_class
  )
} 

cat("\nâœ” Loop completed.\n")

results_folds
```

```{r}
#Spearman calculation inter-folds

spearman_between_folds <- list()

for (class_k in classes) {
  shap_class_list <- lapply(results_folds, function(fold) fold$shap[[class_k]])
  
  n_folds <- length(shap_class_list)
  corr_matrix <- matrix(NA, nrow = n_folds, ncol = n_folds)
  rownames(corr_matrix) <- paste0("Fold_", 1:n_folds)
  colnames(corr_matrix) <- paste0("Fold_", 1:n_folds)
  
  for (i in 1:n_folds) {
    for (j in i:n_folds) {
      fold_i <- shap_class_list[[i]]
      fold_j <- shap_class_list[[j]]
      
      common_vars <- intersect(colnames(fold_i), colnames(fold_j))
      fold_i <- fold_i[, common_vars, drop = FALSE]
      fold_j <- fold_j[, common_vars, drop = FALSE]
      
      n_patients <- min(nrow(fold_i), nrow(fold_j))
      vec_i <- as.numeric(as.matrix(fold_i[1:n_patients, ]))
      vec_j <- as.numeric(as.matrix(fold_j[1:n_patients, ]))
      
      corr_matrix[i,j] <- cor(vec_i, vec_j, method = "spearman", use = "pairwise.complete.obs")
      corr_matrix[j,i] <- corr_matrix[i,j]
    }
  }
  
  spearman_between_folds[[class_k]] <- corr_matrix
}

spearman_between_folds[["EarlyRelapse"]]
```

```{r}
mat_EarlyRelapse <- spearman_between_folds[["EarlyRelapse"]]
mean_corr_EarlyRelapse <- mean(mat_EarlyRelapse[upper.tri(mat_EarlyRelapse)])
sd_corr_EarlyRelapse <- sd(mat_EarlyRelapse[upper.tri(mat_EarlyRelapse)])
cat("Mean Spearman between folds for Early Relapse:", mean_corr_EarlyRelapse, "\nSD:", sd_corr_EarlyRelapse, "\n")
```

```{r}
sapply(classes, function(class_k) {
  mat <- spearman_between_folds[[class_k]]
  mean(mat[upper.tri(mat)])
})
```

